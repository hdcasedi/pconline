{# ==== FLASHCARD STUDY VIEWER (une carte √† la fois) ==== #}
{% load wagtailcore_tags %}

{% with cards=cards|default:page.random_cards10 %}
<div class="h-full flex flex-col">
  <!-- Progress -->
  <div class="px-4 py-2 bg-slate-50 border-b border-slate-200">
    <div class="flex items-center justify-between mb-2">
      <span class="text-xs font-medium text-slate-600">Progression</span>
      <span class="text-xs text-slate-500">
        <span id="fc-counter">0 / 0</span>
      </span>
    </div>
    <div id="fc-progress-container" class="flex gap-0.5 h-2 rounded-full overflow-hidden bg-white border border-slate-200">
      <!-- Les segments de progression seront g√©n√©r√©s dynamiquement -->
    </div>
  </div>

  <!-- Card area -->
  <div class="flex-1 p-4 flex flex-col items-center justify-center">
    <!-- Carte qui occupe 80% de la hauteur -->
    <div id="fc-card" class="fc w-full max-w-2xl h-4/5 max-h-80 bg-white border border-slate-200 rounded-xl shadow-sm cursor-pointer select-none mb-4">
      <div class="fc-inner w-full h-full">
        <!-- Face question -->
        <div class="fc-face flex flex-col h-full">
          <!-- En-t√™te Question -->
          <div class="bg-blue-600 text-white text-center py-2 px-4 rounded-t-xl">
            <span class="font-semibold text-sm">Question</span>
          </div>
          <!-- Contenu centr√© -->
          <div class="flex-1 flex items-center justify-center p-5">
            <div id="fc-q" class="prose max-w-none text-slate-800 text-center"></div>
          </div>
        </div>
        <!-- Face r√©ponse -->
        <div class="fc-face fc-back flex flex-col h-full">
          <!-- En-t√™te R√©ponse -->
          <div class="bg-green-500 text-white text-center py-2 px-4 rounded-t-xl">
            <span class="font-semibold text-sm">R√©ponse</span>
          </div>
          <!-- Contenu centr√© -->
          <div class="flex-1 flex items-center justify-center p-5">
            <div id="fc-a" class="prose max-w-none text-slate-800 text-center"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Boutons Juste/Faux -->
    <div class="flex gap-4">
      <button id="fc-wrong-btn" type="button"
              class="rounded-lg bg-red-600 px-6 py-3 text-sm font-medium text-white hover:bg-red-700 transition-colors">
        ‚ùå Faux
      </button>
      <button id="fc-correct-btn" type="button"
              class="rounded-lg bg-green-600 px-6 py-3 text-sm font-medium text-white hover:bg-green-700 transition-colors">
        ‚úÖ Juste
      </button>
    </div>
  </div>

  <!-- Hidden source (question/r√©ponse d√©j√† rendues en HTML) -->
  <div id="fc-source" class="hidden">
    {% for c in cards %}
      <div class="flash-item">
        <div class="q">{% if c.question %}{{ c.question|richtext }}{% else %}<p>(sans question)</p>{% endif %}</div>
        <div class="a">{% if c.answer %}{{ c.answer|richtext }}{% else %}<p>(sans r√©ponse)</p>{% endif %}</div>
      </div>
    {% empty %}
      <div class="flash-item"><div class="q"><p>Aucune carte.</p></div><div class="a"><p>‚Äî</p></div></div>
    {% endfor %}
  </div>

  <!-- Popup de fin -->
  <div id="fc-end-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-md mx-4 text-center">
      <div class="text-6xl mb-4">üéâ</div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Bravo !</h2>
      <p class="text-lg text-gray-600 mb-6">Vous avez eu <span id="fc-final-score" class="font-bold text-blue-600">0/0</span></p>
      <button id="fc-restart-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
        üîÑ Recommencer une nouvelle s√©rie
      </button>
    </div>
  </div>
</div>

<style>
/* flip */
.fc { perspective: 1200px; }
.fc-inner { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform .5s; }
.fc.flipped .fc-inner { transform: rotateY(180deg); }
.fc-face { position: absolute; inset: 0; backface-visibility: hidden; }
.fc-back { transform: rotateY(180deg); }
.prose :where(pre, code){ white-space: pre-wrap; }

/* Styles pour les questions et r√©ponses */
#fc-q {
  color: #374151 !important; /* gris fonc√© pour le contenu */
}

#fc-a {
  color: #374151 !important; /* gris fonc√© pour le contenu */
}

/* Responsive adjustments */
@media (max-width: 640px) {
  #fc-card {
    max-width: 100%;
    height: 60vh;
  }
}

/* Desktop adjustments */
@media (min-width: 641px) {
  #fc-card {
    max-width: 600px;
    height: 400px;
  }
}
</style>

<script>
(function(){
  // ‚Äî‚Äî‚Äî helpers
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const src = $("#fc-source");
  const items = $$(".flash-item", src).map(el => ({
    q: $(".q", el)?.innerHTML?.trim() || "",
    a: $(".a", el)?.innerHTML?.trim() || ""
  }));

  // shuffle util
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  // state
  let idx = 0, total = items.length, correct = 0, wrong = 0;
  let questionStatus = []; // 0=pas r√©pondu, 1=juste, 2=faux, 3=en cours, 4=pas not√©

  // els
  const card = $("#fc-card");
  const qEl = $("#fc-q");
  const aEl = $("#fc-a");
  const counter = $("#fc-counter");
  const progressContainer = $("#fc-progress-container");
  const okBtn = $("#fc-correct-btn");
  const koBtn = $("#fc-wrong-btn");
  const endPopup = $("#fc-end-popup");
  const finalScore = $("#fc-final-score");
  const restartBtn = $("#fc-restart-btn");

  function createProgressBar() {
    progressContainer.innerHTML = '';
    for (let i = 0; i < total; i++) {
      const segment = document.createElement('div');
      segment.className = 'flex-1 transition-colors duration-200';
      segment.dataset.index = i;
      progressContainer.appendChild(segment);
    }
  }

  function updateProgressBar() {
    const segments = progressContainer.children;
    for (let i = 0; i < total; i++) {
      const segment = segments[i];
      const status = questionStatus[i] || 0;
      
      // Supprimer toutes les classes de couleur
      segment.className = 'flex-1 transition-colors duration-200';
      
      // Ajouter la classe de couleur selon le statut
      switch(status) {
        case 1: // Juste
          segment.classList.add('bg-emerald-500');
          break;
        case 2: // Faux
          segment.classList.add('bg-rose-500');
          break;
        case 3: // En cours
          segment.classList.add('bg-blue-500');
          break;
        case 4: // Pas not√©
          segment.classList.add('bg-slate-400');
          break;
        default: // Pas r√©pondu
          segment.classList.add('bg-white', 'border-r', 'border-slate-300');
          if (i === total - 1) segment.classList.remove('border-r');
          break;
      }
    }
  }

  function setProgress(){
    counter.textContent = (total? (idx+1):0) + " / " + total;
    
    // Marquer la question actuelle comme "en cours"
    if (total > 0) {
      questionStatus[idx] = 3;
      updateProgressBar();
    }
  }

  function typesetMath(scope){
    if (window.MathJax && MathJax.typesetPromise) {
      MathJax.typesetPromise([scope]).catch(()=>{});
    }
  }

  function render(){
    if (!total) {
      qEl.innerHTML = "<p>Aucune carte.</p>";
      aEl.innerHTML = "<p>‚Äî</p>";
      setProgress();
      return;
    }
    const it = items[idx];
    qEl.innerHTML = it.q || "<p>(sans question)</p>";
    aEl.innerHTML = it.a || "<p>(sans r√©ponse)</p>";
    card.classList.remove("flipped");
    setProgress();
    typesetMath(card);
  }

  function flip(){
    card.classList.toggle("flipped");
    typesetMath(card);
  }

  function next(){
    if (!total) return;
    idx = (idx+1) % total;
    
    // V√©rifier si on a termin√© toutes les questions
    if (idx === 0) {
      showEndPopup();
    } else {
      render();
    }
  }

  function showEndPopup() {
    finalScore.textContent = `${correct}/${total}`;
    endPopup.classList.remove('hidden');
  }

  function restart() {
    // R√©initialiser les compteurs
    correct = 0;
    wrong = 0;
    idx = 0;
    questionStatus = [];
    
    // M√©langer les cartes
    shuffle(items);
    
    // Recr√©er la barre de progression
    createProgressBar();
    
    // Cacher la popup et re-rendre
    endPopup.classList.add('hidden');
    render();
  }

  function prev(){
    if (!total) return;
    idx = (idx-1+total) % total;
    render();
  }

  // events
  card.addEventListener("click", flip);
  okBtn.addEventListener("click", () => { 
    correct++; 
    questionStatus[idx] = 1; // Marquer comme juste
    next(); 
  });
  koBtn.addEventListener("click", () => { 
    wrong++; 
    questionStatus[idx] = 2; // Marquer comme faux
    next(); 
  });
  restartBtn.addEventListener("click", restart);

  // keyboard
  document.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if (k === " "){ e.preventDefault(); flip(); }
    else if (k === "n"){ next(); }
    else if (k === "p"){ prev(); }
    else if (k === "j"){ 
      correct++; 
      questionStatus[idx] = 1; // Marquer comme juste
      next(); 
    }
    else if (k === "f"){ 
      wrong++; 
      questionStatus[idx] = 2; // Marquer comme faux
      next(); 
    }
  });

  // init
  shuffle(items); // tirage au hasard initial
  createProgressBar();
  render();
})();
</script>
{% endwith %}
